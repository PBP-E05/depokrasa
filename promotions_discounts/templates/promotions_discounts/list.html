{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}
<div class="min-h-screen bg-primaryBackground flex items-center justify-center p-4">
    <div class="w-full max-w-6xl bg-white rounded-lg shadow-lg p-6">
        <div class="text-center mb-8">
            <br>
            <br>
            <br>
            <br>
            <br>
            <h2 class="text-2xl font-bold text-gray-900">Makanan dengan Diskon di DepokRasa</h2>
            <p class="text-gray-500 mt-2">Temukan makanan dengan harga spesial untuk Anda</p>
        </div>

        <!-- Button to go to Select Favorite Shops (Filter page) -->
        <div class="text-center mb-8">
            <a href="{% url 'promotions_discounts:select_favorite_shops' %}" class="px-4 py-2 bg-orange-500 text-white rounded-lg font-medium hover:bg-orange-600 transition duration-150 ease-in-out">
                Filter Berdasarkan Restoran
            </a>
        </div>

        <!-- Discounted Foods Section -->
        <div class="mb-10">
            <h2 class="text-2xl font-semibold mb-4 text-center">Makanan dengan Diskon</h2>
            {% if discounted_foods %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for food in discounted_foods %}
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-md">
                            <h3 class="text-lg font-bold text-gray-800">{{ food.food_name }}</h3>
                            <p class="text-sm text-gray-600">Restoran: {{ food.shop_name }}</p>
                            <p class="text-sm text-gray-600">Harga Asli: Rp {{ food.original_price|floatformat:2 }}</p>
                            <p class="text-sm text-gray-600">Diskon: {{ food.discount_percentage }}%</p>
                            <p class="text-sm text-orange-500 font-semibold">Harga Setelah Diskon: Rp {{ food.discounted_price|floatformat:2 }}</p>
                            <p class="text-xs text-gray-500">Berlaku hingga: <span id="timer-{{ forloop.counter }}">{{ food.valid_until }}</span></p>
                        </div>

                        <script>
                            document.addEventListener("DOMContentLoaded", function () {
                                const endDate = new Date("{{ food.valid_until|date:'c' }}");
                                const timerElement = document.getElementById("timer-{{ forloop.counter }}");

                                function updateTimer() {
                                    const now = new Date().getTime();
                                    const distance = endDate - now;

                                    if (distance < 0) {
                                        clearInterval(interval);
                                        timerElement.innerHTML = "Kadaluarsa";
                                    } else {
                                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                        timerElement.innerHTML = days + "h " + hours + "j " + minutes + "m ";
                                    }
                                }

                                const interval = setInterval(updateTimer, 1000);
                                updateTimer();
                            });
                        </script>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 text-center">Tidak ada diskon aktif saat ini.</p>
            {% endif %}
        </div>

        <!-- Active Promotions Section -->
        <div class="mb-10">
            <h2 class="text-2xl font-semibold mb-4 text-center">Promosi Aktif</h2>
            {% if promotions %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for promotion in promotions %}
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-md">
                            <h3 class="text-lg font-bold text-gray-800">{{ promotion.shop.name }}</h3>
                            <p class="text-sm text-gray-600">Promosi: {{ promotion.promotion_type }}</p>
                            <p class="text-sm text-gray-600">{{ promotion.description }}</p>
                            <p class="text-xs text-gray-500">Berlaku hingga: {{ promotion.end_date }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 text-center">Tidak ada promosi aktif saat ini.</p>
            {% endif %}
        </div>
    </div>
</div>
<!-- AJAX script untuk menghapus diskon yang sudah kadaluwarsa setiap 60 detik -->
<script>
    setInterval(function () {
        fetch("{% url 'promotions_discounts:delete_expired_discounts' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.deleted) {
                location.reload();
            }
        })
        .catch(error => console.error("Error saat menghapus diskon kadaluwarsa:", error));
    }, 60000);
</script>
{% include 'footer.html' %}
{% endblock %}
