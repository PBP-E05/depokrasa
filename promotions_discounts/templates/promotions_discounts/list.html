{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto mt-10 p-5">
    <h1 class="text-3xl font-bold mb-6 text-center">Discounted Foods</h1>

    <div class="mb-10">
        <h2 class="text-2xl font-semibold mb-4">Active Discounts on Foods</h2>
        {% if discounted_foods and discounted_foods|length > 0 %}
            <ul class="bg-white shadow-md rounded-lg p-5">
                {% for food in discounted_foods %}
                    <li class="border-b border-gray-200 py-3">
                        <h3 class="text-xl font-bold">{{ food.food_name }}</h3>
                        <p>Shop: {{ food.shop_name }}</p>
                        <p>Original Price: {{ food.original_price }}</p>
                        <p>Discount: {{ food.discount_percentage }}%</p>
                        <p>Discounted Price: {{ food.discounted_price }}</p>
                        <p>Valid until: <span id="timer-{{ forloop.counter }}"></span></p>
                    </li>

                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const endDate = new Date("{{ food.valid_until }}");
                            const timerElement = document.getElementById("timer-{{ forloop.counter }}");

                            const interval = setInterval(function () {
                                const now = new Date().getTime();
                                const distance = endDate - now;

                                if (distance < 0) {
                                    clearInterval(interval);
                                    timerElement.innerHTML = "Expired";
                                } else {
                                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                    timerElement.innerHTML = days + "d " + hours + "h " + minutes + "m ";
                                }
                            }, 1000);
                        });
                    </script>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-500">No active discounts available at the moment.</p>
        {% endif %}
    </div>

    <div>
        <h2 class="text-2xl font-semibold mb-4">Active Promotions</h2>
        {% if promotions %}
            <ul class="bg-white shadow-md rounded-lg p-5">
                {% for promotion in promotions %}
                    <li class="border-b border-gray-200 py-3">
                        <h3 class="text-xl font-bold">{{ promotion.restaurant_name }}</h3>
                        <p>Promotion: {{ promotion.promotion_name }}</p>
                        <p>{{ promotion.promotion_description }}</p>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-500">No active promotions available at the moment.</p>
        {% endif %}
    </div>
</div>

<script>
    // AJAX to delete expired discounts every 60 seconds
    setInterval(function () {
        $.ajax({
            url: '/promotions/delete_expired/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function(response) {
                if (response.deleted) {
                    location.reload();
                }
            },
            error: function(xhr, status, error) {
                console.error("Error saat menghapus diskon expired:", error);
            }
        });
    }, 60000);
</script>
{% endblock %}
